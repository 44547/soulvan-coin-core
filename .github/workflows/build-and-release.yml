name: Build and Release Soulvan Core

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v2.0.0). If omitted, uses ref name."
        required: false
        type: string

permissions:
  contents: write

concurrency:
  group: soulvan-core-release-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build-windows:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version != '' && inputs.version || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Unity version from ProjectSettings
        id: unity_version
        run: |
          ver=$(grep 'm_EditorVersion:' unity/ProjectSettings/ProjectVersion.txt | sed 's/.*: //')
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: |
            unity/Library
            unity/Logs
          key: Library-${{ runner.os }}-${{ steps.unity_version.outputs.version }}
          restore-keys: |
            Library-${{ runner.os }}-

      - name: Build (Windows x86_64)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: unity
          unityVersion: ${{ steps.unity_version.outputs.version }}
          targetPlatform: StandaloneWindows64
          buildName: SoulvanCore
          buildsPath: build
          versioning: Custom
          version: ${{ env.VERSION }}

      - name: Package Windows build
        run: |
          cd build
          zip -r SoulvanCore_Windows_x86_64.zip StandaloneWindows64 || (echo "Build folder not found" && ls -la && exit 1)
          ls -lh SoulvanCore_Windows_x86_64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SoulvanCore_Windows_x86_64-${{ env.VERSION }}
          path: build/SoulvanCore_Windows_x86_64.zip
          if-no-files-found: error
          retention-days: 14

  build-linux:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ inputs.version != '' && inputs.version || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Unity version from ProjectSettings
        id: unity_version
        run: |
          ver=$(grep 'm_EditorVersion:' unity/ProjectSettings/ProjectVersion.txt | sed 's/.*: //')
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: |
            unity/Library
            unity/Logs
          key: Library-${{ runner.os }}-${{ steps.unity_version.outputs.version }}
          restore-keys: |
            Library-${{ runner.os }}-

      - name: Build (Linux x86_64)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: unity
          unityVersion: ${{ steps.unity_version.outputs.version }}
          targetPlatform: StandaloneLinux64
          buildName: SoulvanCore
          buildsPath: build
          versioning: Custom
          version: ${{ env.VERSION }}

      - name: Package Linux build
        run: |
          cd build
          zip -r SoulvanCore_Linux_x86_64.zip StandaloneLinux64 || (echo "Build folder not found" && ls -la && exit 1)
          ls -lh SoulvanCore_Linux_x86_64.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SoulvanCore_Linux_x86_64-${{ env.VERSION }}
          path: build/SoulvanCore_Linux_x86_64.zip
          if-no-files-found: error
          retention-days: 14

  build-macos:
    runs-on: macos-latest
    env:
      VERSION: ${{ inputs.version != '' && inputs.version || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read Unity version from ProjectSettings
        id: unity_version
        run: |
          ver=$(grep 'm_EditorVersion:' unity/ProjectSettings/ProjectVersion.txt | sed 's/.*: //')
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: |
            unity/Library
            unity/Logs
          key: Library-${{ runner.os }}-${{ steps.unity_version.outputs.version }}
          restore-keys: |
            Library-${{ runner.os }}-

      - name: Build (macOS)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        with:
          projectPath: unity
          unityVersion: ${{ steps.unity_version.outputs.version }}
          targetPlatform: StandaloneOSX
          buildName: SoulvanCore
          buildsPath: build
          versioning: Custom
          version: ${{ env.VERSION }}

      - name: Package macOS build
        run: |
          cd build
          zip -r SoulvanCore_macOS_universal.zip StandaloneOSX || (echo "Build folder not found" && ls -la && exit 1)
          ls -lh SoulvanCore_macOS_universal.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: SoulvanCore_macOS_universal-${{ env.VERSION }}
          path: build/SoulvanCore_macOS_universal.zip
          if-no-files-found: error
          retention-days: 14

  release:
    runs-on: ubuntu-latest
    needs: [ build-windows, build-linux, build-macos ]
    if: startsWith(github.ref, 'refs/tags/') || inputs.version != ''
    env:
      VERSION: ${{ inputs.version != '' && inputs.version || github.ref_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten artifacts
        run: |
          mkdir -p release
          find dist -name "*.zip" -exec cp {} release/ \;
          ls -lh release

      - name: Create GitHub Release (all platforms)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: Soulvan Core ${{ env.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(env.VERSION, 'rc') || contains(env.VERSION, 'beta') || contains(env.VERSION, 'alpha') }}
          files: |
            release/SoulvanCore_Windows_x86_64.zip
            release/SoulvanCore_Linux_x86_64.zip
            release/SoulvanCore_macOS_universal.zip
